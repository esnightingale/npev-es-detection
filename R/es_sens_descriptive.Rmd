---
title: 'Part 2: Site ES detection'
subtitle: '2A: Descriptive'
output:
  html_document:
    df_print: paged
---

```{r}

pacman::p_load(tidyverse, here, janitor, gtsummary, sf, spdep, patchwork)
theme_set(theme_minimal())

dir <- "data/Pakistan/analysis"
figdir <- "figures/descriptive/es"
plotdir <- "figures/descriptive/es/plotobj"

# ES data
es <- readRDS(here(dir, "es_analysis.rds"))
sites <- readRDS(here(dir, "sites_analysis.rds"))

# Catchments
catch_5k <- readRDS(here(dir , "catch_5k.rds"))
catch_wsh <- readRDS(here(dir , "catch_wsh.rds"))

# Shapefiles 
shape2 <- readRDS(here(dir,"shape2.rds")) |> st_transform(4326)

# Define a minimum site sample size for analysis 
min_ss = 10

es |> mutate(incl_site = site_total >= min_ss) -> es

```

# Descriptive

## All sites

```{r}

n_distinct(es$site_id)

es |> 
  group_by(year, month) |> 
  summarise(n_sites = n_distinct(site_id),
            samp_per_site = n()/n_sites) |> 
  ungroup() |> 
  ggplot(aes(month, n_sites)) +
  geom_col() +
  geom_line(aes(y = samp_per_site*100)) +
  scale_y_continuous(name = "No. unique sites",
                     sec.axis = sec_axis(transform=~./100, 
                                         name = "Monthly samples per site")) +
  labs(x = NULL) -> p_collect

p_collect
saveRDS(p_collect, here(plotdir,"p_collect.rds"))
ggsave(here(figdir,"collect_mth.png"),
       height = 4, width = 6, bg = "white")

```

### Samples per site

```{r}

sites |> 
  group_by(total_collections) |> 
  count() |> 
  ungroup() |> slice_max(n, n = 5) |> pull(total_collections) -> max_n

ggplot(sites, aes(total_collections)) + 
  geom_histogram() + 
  # geom_vline(xintercept = max_n-0.5) + 
  # scale_x_continuous(trans = "log2") +
  labs(x = "Total sample collections, 2021-24", 
       y = "No. sites")

```

Coverage by samples per site:
```{r}

shape2 |> 
  ggplot(fill = NULL) +
  geom_sf() + 
  geom_sf(data = sites |> arrange(total_collections), inherit.aes = F, shape = 23,
          aes(fill = factor(total_collections>=10,
                            labels = c("< 10",">=10")))) +
  # scale_fill_viridis_b("Total collections") +
  theme(axis.text = element_blank(), 
        legend.position = c(0.8,0.2),
        legend.box.background = element_rect(fill = "white")) +
  labs(fill = "Total no. samples",
       title = "Environmental surveillance coverage in Pakistan",
       subtitle = "All sampled sites") -> p_covg_all

p_covg_all
saveRDS(p_covg_all, here(plotdir,"p_covg_all.rds"))
ggsave(here(figdir, "site_covg_all.png"),
       height = 6, width = 6, bg = "white")

shape2 |> 
  ggplot(fill = NULL) +
  geom_sf() + 
  geom_sf(data = sites |> filter(total_collections >= min_ss), 
          inherit.aes = F, aes(shape = "Site"), fill = "white") +
  scale_shape_manual(values = 23) + 
  theme(axis.text = element_blank(), 
        legend.position = c(0.8,0.2),
        legend.box.background = element_rect(fill = "white")) +
  labs(shape = NULL, 
       title = "Environmental surveillance coverage in Pakistan",
       subtitle = paste0("Sites with at least ",min_ss," sample(s), 2021-2024")) -> p_covg_incl

p_covg_incl
saveRDS(p_covg_incl, here(plotdir,"p_covg_incl.rds"))
ggsave(here(figdir,"site_covg_incl.png"),
       height = 6, width = 6, bg = "white")

```

### Regularity of sampling

```{r}

es |> 
  mutate(site_id = forcats::fct_reorder(site_id, 
                                         desc(as.numeric(site_class)))) |> 
  ggplot(aes(collection_date, site_id, col = site_class)) +
  geom_point(pch = 18) + 
  theme(axis.text.y = element_blank(), 
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "white")) +
  scale_colour_viridis_d(option = "turbo") +
  labs(x = "Sample collection date", y = "Site", colour = "Site Class") -> p_site_samp

p_site_samp
saveRDS(p_site_samp, here(plotdir,"p_site_samp.rds"))
ggsave(here(figdir,"site_sampling.png"),
       height = 10, width = 8, bg = "white")

es |> 
  mutate(site_id = forcats::fct_reorder(site_id, desc(as.numeric(site_class)))) |> 
  ggplot(aes(collection_date, site_id, col = site_class)) +
  geom_point(pch = 18) + 
  facet_wrap(~admin_1, scales = "free_y") +
  theme(axis.text.y = element_blank(), 
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "white")) +
  scale_colour_viridis_d(option = "turbo") +
  labs(x = "Sample collection date", y = "Site", colour = "Site Class") -> p_site_samp_prov

p_site_samp_prov
saveRDS(p_site_samp, here(plotdir,"p_site_samp.rds"))
ggsave(here(figdir,"site_sampling_prov.png"),
       height = 8, width = 10, bg = "white")
```
Proportion of classes by province:
```{r}

sites |> 
  st_join(shape2, st_within) |> 
  ggplot(aes(adm1_name, fill = site_class)) + 
  geom_bar() + 
  scale_fill_viridis_d(option = "turbo") + 
  theme(legend.position = c(0.2,0.8), legend.box.background = element_rect(fill = "white")) +
  labs(x = NULL, y = "No. sites", fill = "Site class") -> p_class_prov

p_class_prov
saveRDS(p_class_prov, here(plotdir,"p_class_prov.rds"))
ggsave(here(figdir,"site_class_prov.png"),
       height = 6, width = 8, bg = "white")

sites |> 
  st_join(shape2, st_within) |> 
  st_drop_geometry() |> 
  group_by(adm1_name, site_class) |> 
  count() |> 
  group_by(adm1_name) |> 
  mutate(p = n/sum(n)) |> 
  ggplot(aes(adm1_name, p, fill = site_class)) + 
  geom_col() + 
  scale_fill_viridis_d(option = "turbo") + 
  labs(x = NULL, y = "Proportion", fill = "Site class") -> p_class_prov_p

p_class_prov_p
saveRDS(p_class_prov_p, here(plotdir,"p_class_prov_p.rds"))
ggsave(here(figdir,"site_class_prov_p.png"),
       height = 6, width =10, bg = "white")

```
### PV positivity

- PV+ samples will be excluded from analysis due to masking of NPEV.
- Should this include vaccine virus or just wild type?

Distribution of PV+ samples over time:
```{r}

# Only wild/VD polioviruses
tabyl(es$pv)
es |> 
  group_by(month) |> 
  summarise(npv = sum(!pv),
            pv = sum(pv)) |>
  pivot_longer(npv:pv) |>
  mutate(name = factor(name, labels = c("PV-","PV+"))) |> 
  ggplot(aes(month, value, fill = name)) +
  geom_col(position = position_dodge()) +
  scale_fill_manual(values = c("black", "grey")) +
  scale_y_continuous(trans = "sqrt") +
  theme(legend.position = c(0.2,0.9)) +
  labs(x = "Month", y = "No. samples", fill = NULL) -> p_pv_pos
p_pv_pos

saveRDS(p_pv_pos, here(plotdir,"p_pv_pos.rds"))
ggsave(here(figdir,"p_pv_pos.png"),
       height = 4, width = 6, bg = "white")

# Also vaccine viruses
tabyl(grepl("VACCINE",es$virus_type_s))
es |> 
  group_by(month) |> 
  summarise(npv = sum(!grepl("VACCINE",virus_type_s) & !pv),
            pv = sum(grepl("VACCINE",virus_type_s) | pv)) |> 
  pivot_longer(npv:pv) |>
  mutate(name = factor(name, labels = c("PV-","PV+ (incl. vaccine)"))) |> 
  ggplot(aes(month, value, fill = name)) +
  geom_col(position = position_dodge()) +
  scale_fill_manual(values = c("black", "grey")) +
  scale_y_continuous(trans = "sqrt") +
  theme(legend.position = c(0.2,0.9)) +
  labs(x = "Month", y = "No. samples", fill = NULL) -> p_pv_vax_pos
p_pv_vax_pos

saveRDS(p_pv_vax_pos, here(plotdir,"p_pv_vax_pos.rds"))
ggsave(here(figdir,"p_pv_vax_pos.png"),
       height = 4, width = 6, bg = "white")

```
Just looking at WPV/VDPV:
-> increasing since mid-2023. 
-> Reduced sample size in recent years - will this be a problem?

```{r}

p_collect + p_pv_vax_pos +
  plot_annotation(tag_levels = "A")
ggsave(here(figdir,"es_time.png"),
       height = 4, width = 10, bg = "white")

```

### Positivity by site class

```{r}

es |> 
  mutate(npev = factor(is.na(npev), levels = c(T,F), labels = c("No","Yes")),
         site_class = fct_relabel(site_class, 
                                  ~gsub("or ","or\n",
                                    gsub(" (","\n(", .x, fixed = T)))) |> 
  ggplot(aes(site_class, fill = site_class, alpha = npev)) + 
  geom_bar(position = position_dodge()) + 
  labs(x = NULL, y= "Samples", fill = NULL, alpha = "NPEV detected") + 
  guides(fill = "none") +
  scale_alpha_manual(values = c(0.5,1)) + 
  scale_fill_viridis_d(option = "turbo") +
  theme(legend.position = c(0.8,0.8)) -> p_npev_class

p_npev_class
saveRDS(p_npev_class, here(plotdir,"p_npev_class.rds"))
ggsave(here(figdir,"npev_byclass.png"),
       height = 4, width = 10, bg = "white")

es |> 
  mutate(
    pv = factor((grepl("VACCINE",virus_type_s) | pv),
                     levels = c(F,T), labels = c("No",
                                                 "Yes")),
    # pv = factor(pv, levels = c(T,F), labels = c("PV-","PV+")),
         site_class = fct_relabel(site_class, 
                                  ~gsub("or ","or\n",
                                    gsub(" (","\n(", .x, fixed = T)))) |> 
  ggplot(aes(site_class, fill = site_class, alpha = pv)) + 
  geom_bar(position = position_dodge()) + 
  labs(x = NULL, y= "Samples", fill = NULL, alpha = "Any poliovirus detected\n(incl. vaccine)") + 
  guides(fill = "none") +
  scale_alpha_manual(values = c(0.5,1)) + 
  scale_fill_viridis_d(option = "turbo") +
  theme(legend.position = c(0.8,0.8)) -> p_pv_class

p_pv_class
saveRDS(p_pv_class, here(plotdir,"p_pv_class.rds"))
ggsave(here(figdir,"pv_vax_byclass.png"),
       height = 4, width = 10, bg = "white")

```
* Across all site classes except full monthly, more likely to detect NPEV than not. 
* Samples from sites with frequent and consistent collections are more like 50:50 (the target level).

The pattern across NPEV is interesting since surveillance is not specifically *looking* for NPEV. 
* There has been an increase overall in NPEV in recent years, so newer sites (monthly since est.) have a higher proportion of NPEV+ samples. 

For PV on the other hand, samples from regularly sampled sites are much more likely to be positive. This makes sense because sites positioned/collections scheduled to find poliovirus. 

Quickly test this:

```{r}

es |> 
  mutate(site_class = fct_drop(site_class),
         npev = factor(is.na(npev), 
                       levels = c(T,F), labels = c("Negative", "Positive")),
         pv = factor((grepl("VACCINE",virus_type_s) | pv),
                     levels = c(F,T), labels = c("Negative", "Positive"))) |> 
  tbl_summary(include = c(npev, pv),
              by = site_class,
              label = list(npev = "NPEV", 
                           pv = "Poliovirus (incl. vaccine)")) |> 
  add_p()

```

Look at cross-detection of PV/NPEV:

```{r}
es |> 
  mutate(npev = factor(is.na(npev), 
                       levels = c(T,F), labels = c("Negative", "Positive"))) |> 
  tbl_summary(include = npev,
              by = pv,
              label = list(npev = "NPEV", 
                           pv = "Poliovirus (excl. vaccine)")) |> 
  add_p()

es |> 
  mutate(npev = factor(is.na(npev), 
                       levels = c(T,F), labels = c("Negative", "Positive")),
         pv_vax = factor((grepl("VACCINE",virus_type_s) | pv),
                     levels = c(F,T), labels = c("Negative", "Positive"))) |> 
  tbl_summary(include = npev,
              by = pv_vax,
              label = list(npev = "NPEV", 
                           pv = "Poliovirus (incl. vaccine)")) |> 
  add_p()

es |> 
  mutate(npev = factor(is.na(npev), 
                       levels = c(T,F), labels = c("Negative", "Positive")),
         final_class = fct_na_value_to_level(final_class, "None")) |> 
  tbl_summary(include = npev,
              by = final_class,
              label = list(npev = "NPEV"))

```

Definitely seems less likely to detect NPEV if any PV detected. 

# Other site characteristics

```{r}

es |> 
  left_join(sites) |> 
  mutate(npev = factor(is.na(npev), 
                       levels = c(T,F), labels = c("Negative", "Positive")),
         pv = factor((grepl("VACCINE",virus_type_s) | pv),
                     levels = c(F,T), labels = c("Negative", "Positive")),
         built21 = as.numeric(built21*100)) |> 
  tbl_summary(include = c(catchment_pop_5k, built21, precip21),
              by = pv,
              label = list(catchment_pop_5k = "Population catchment", 
                           built21 = "Built-up surface (%)",
                           precip21 = "Annual average precipitation")) |> 
  add_p()

```

## Included sites

Summarise site level prevalence for those that meet minimum sample size:
```{r}

es <- filter(es, incl_site)

es |> 
  mutate(npev = npev_f == "NPEV+") |> 
  tbl_summary(include = c(pv, npev),
              by = year,
              label = list(pv = "Poliovirus positives",
                           npev = "NPEV positives")) |> 
  add_overall() |> 
  as_gt()

es |> 
  group_by(year, month, site_id) |> 
  summarise(n_samp = n(),
            n_npev = sum(npev_f=="NPEV+"),
            p_npev = n_npev/n_samp) |> 
  ungroup() |> 
  tbl_summary(include = c(n_samp, n_npev, p_npev),
              by = year,
              label = list(n_samp = "Collected samples", 
                           n_npev = "NPEV positives", 
                           p_npev = "Crude NPEV prevalence")) |> 
  add_overall() |> 
  as_gt()

es |> 
  group_by(year, site_id) |> 
  summarise(n_samp = n(),
            n_pv = sum(pv),
            n_npev = sum(npev_f=="NPEV+"),
            p_npev = n_npev/n_samp) |> 
  ungroup() |> 
  tbl_summary(include = c(n_samp, n_pv, n_npev, p_npev),
              by = year,
              label = list(n_samp = "Collected samples", 
                           n_pv = "Poliovirus positives", 
                           n_npev = "NPEV positives", 
                           p_npev = "Crude NPEV prevalence")) |> 
  add_overall() |> 
  as_gt()

es |> 
  group_by(site_id) |> 
  summarise(n_samp = n(),
            n_pv = sum(pv),
            n_npev = sum(npev_f=="NPEV+"),
            p_npev = n_npev/n_samp) |> 
  ungroup() |> 
  tbl_summary(include = c(n_samp, n_pv, n_npev, p_npev),
              label = list(n_samp = "Collected samples", 
                           n_pv = "Poliovirus positives", 
                           n_npev = "NPEV positives", 
                           p_npev = "Crude NPEV prevalence")) |> 
  as_gt()

```

### Seasonality 

```{r}

# Samples by month of year
es |> 
  group_by(month_of_year) |> 
  summarise(n = n(),
            npev = sum(!is.na(npev)),
            p_npev = npev*100/n) |> 
  ungroup() -> es_moy

ggplot() + 
  geom_bar(data = es, 
           aes(month_of_year, fill = npev_f)) + 
  geom_line(data = es_moy, 
            aes(x = month_of_year, y = p_npev*6,
                group = 1)) +
  scale_y_continuous(name = "Collected samples", 
                     sec.axis = sec_axis(trans=~./6, 
                                         name = NULL)) +
  scale_fill_manual(values = c("grey","indianred")) +
  theme(legend.position = c(0.1,0.9)) +
  labs(x = "Collection month", fill = NULL) -> p_moy

es |> 
  group_by(year, month_of_year) |> 
  summarise(n = n(),
            npev = sum(!is.na(npev)),
            p_npev = npev*100/n) |> 
  ungroup() |>
  ggplot(aes(month_of_year, p_npev, 
             col = as.factor(year),
             group = as.factor(year))) + 
  geom_point() +
  geom_smooth(se = F) +
  scale_colour_viridis_d(option = "mako", end = 0.8) +
  ylim(0,100) +
  theme(legend.position = c(0.1,0.9)) +
  labs(x = "Collection month", y = "% Positive", col = NULL) -> p_moy_yr
```

```{r}

p_moy + p_moy_yr + 
  plot_annotation(tag_levels = "A")

ggsave(here("figures/descriptive/es/npev_time.png"),
       height = 4, width = 10, bg = "white")
```