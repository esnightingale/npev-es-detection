---
title: 'Part 1: District NPEV prevalence'
output:
  html_document:
    df_print: paged
---

```{r}

pacman::p_load(tidyverse, here, gtsummary, sf, brms, tidybayes, bayesplot,  
               units, loo, posterior, patchwork)
theme_set(theme_minimal())

dir <- "data/Pakistan/analysis"
figdir <- "figures/final fit"

source(here("R/utils/check_model_fit.R"))
source(here("R/utils/plot_re_fcns.R"))

# Fitting data
fitdata <- read_rds(here(dir,"fitdata.rds"))

# Prediction data (including district:months with zero NPAFP)
preddata <- read_rds(here(dir,"preddata.rds"))

# Shapefiles
shape2 <- readRDS(here(dir,"shape2.rds"))

# Selected model
fit_prior <- readRDS(here("output/prevalence/prior_bym_st_guid.rds"))
fit <- readRDS(here("output/prevalence/fit_bym_st_guid.rds"))

# Define adm1-guid key for later matching:
prov_guid <- fitdata |> 
  select(adm1_name, guid) |> 
  distinct() |> 
  mutate(did = row_number())

```

# Final model

Run final model with longer chains and save predictions:

```{r}

# fit_prior <- update(fit,
#                     refresh=250,
#                     iter = 4000, chains = 4, thin = 10,
#                     cores = parallel::detectCores(),
#                     control = list(adapt_delta = 0.97),
#                     save_pars = save_pars(all = T),
#                     sample_prior = "only",
#                     file = here("output/prevalence/fit_prior.rds"))

# fit <- update(fit,
#                     refresh=250,
#                     iter = 4000, chains = 4, thin = 10,
#                     cores = parallel::detectCores(),
#                     control = list(adapt_delta = 0.97),
#                     save_pars = save_pars(all = T),
#                     file = here("output/fit.rds"))

```

## Prior checks

```{r}

pp_check(fit_prior, 
         "bars",
         samples = 200) -> p_prior_dist

mcmc_areas(fit_prior, 
           pars = get_variables(fit_prior)[1:9],
           prob = 0.8) -> parms_prior

parms_prior +
  ggtitle("Prior distributions",
                      "with medians and 80% intervals")
ggsave(here(figdir,"prior_sample.png"), 
       height = 5, width = 6, bg = "white")
```

## Posterior checks

```{r}

pp_check(fit, 
         "bars",
         samples = 200) -> p_post_dist
p_prior_dist + p_post_dist +
  plot_annotation(tag_levels = "A")

ggsave(here(figdir,"prior_post_dist.png"),
       height = 3, width = 8, bg = "white")

pp_check(fit, type = "rootogram") +
  scale_x_sqrt() +
  theme(legend.position = "inside",
        legend.position.inside = c(0.8, 0.8)) -> p_post_root

p_post_root 

mcmc_trace(fit, 
           pars = get_variables(fit)[1:9],
           facet_args = list(nrow = 2))
ggsave(here(figdir,"mcmc_trace.png"),
       height = 4, width = 8, bg = "white")

```

```{r}

pp_check(fit, type = "pit_ecdf")

```

```{r}

summ_fit <- summary(fit)

# Check Rhat and ESS 
bind_rows(
  summ_fit$fixed[, 5:7],
  bind_rows(summ_fit$random)[, 5:7],
  summ_fit$splines[, 5:7])

```

```{r}

mcmc_areas(fit, 
           pars = get_variables(fit)[1:9],
           prob = 0.8) -> parms_post

parms_post +
  ggtitle("Posterior distributions",
                      "with medians and 80% intervals")
ggsave(here(figdir,"post_sample.png"), 
       height = 5, width = 6, bg = "white")

prior_draws = as_draws_df(fit_prior)[,1:9]
post_draws = as_draws_df(fit)[,1:9]

# Stack the prior and posterior draws for each parameter
#  and reshape to long format
prior_post_draws = bind_rows(
    prior_draws %>% 
      mutate(type="Prior") %>% 
      rename_all(~gsub("prior_", "", .)),
    post_draws %>% 
      select(-matches("Prior")) %>% 
      mutate(type="Posterior")
  ) %>% 
  pivot_longer(-type)

prior_post_draws %>%
 ggplot(aes(value, name, colour=type)) +
  stat_slab(data = . %>% filter(type != "true value"),
               aes(slab_colour=type), fill=NA, normalize="groups", 
               scale=0.7, slab_size=0.5, fatten_point=1.5) +
  geom_segment(data=. %>% filter(type=="true value"), 
               aes(x=value, xend=value, y=name, yend=..y.. + 0.7),
               colour="grey10", size=0.3) +
  coord_cartesian(xlim=c(-3,3)) +
  labs(x=NULL, y=NULL, colour=NULL, fill=NULL, slab_colour=NULL) +
  theme(panel.grid.major.y=element_line(colour="grey10", size=0.2)) -> p_prior_post

# prior_post_draws %>% 
#   ggplot(aes(value, colour=type)) +
#     geom_density(aes(y=after_stat(scaled))) + 
#     facet_wrap(vars(name), scales="free") +
#     labs(x=NULL, y=NULL, colour=NULL, fill=NULL, slab_colour=NULL) +
#     theme(axis.text.y=element_blank(),
#           axis.ticks.y=element_blank()) -> p_prior_post

p_prior_post
```

## Fitted spatial effects

### BYM component

```{r}

fit %>%
  gather_draws(rcar[guid]) %>%
  median_qi() |> 
  left_join(select(preddata, guid, adm1_name) |> 
              distinct() |> 
              mutate(guid = as.numeric(guid))) |> 
  mutate(component = "Total") -> summ_car

summ_car |> 
  arrange(adm1_name, guid) |> 
  mutate(did = row_number()) |> 
  ggplot(aes(did, .value,
             ymin = .lower, ymax = .upper,
             col = adm1_name)) + 
  geom_hline(yintercept = 0, col = "grey") +
  geom_errorbar() + 
  geom_point() +
  labs(x = "District", y = "Posterior estimate", col = "Province",
       subtitle = "Total CAR component") +
  scale_colour_viridis_d(option = "turbo") +
  theme(axis.text.x = element_blank())

fit %>%
  gather_draws(nszcar[guid]) %>%
  median_qi() |> 
  left_join(select(preddata, guid, adm1_name) |> 
              distinct() |> 
              mutate(guid = as.numeric(guid))) |> 
  mutate(component = "Non-spatial") -> summ_car_ns

summ_car |> 
  bind_rows(summ_car_ns) |> 
  arrange(adm1_name, guid) |> 
  mutate(did = row_number()) |> 
  ggplot(aes(did, .value,
             ymin = .lower, ymax = .upper,
             col = adm1_name,
             alpha = component)) + 
  geom_hline(yintercept = 0, col = "grey") +
  geom_errorbar() + 
  geom_point() +
  labs(x = "District", y = "Posterior estimate", 
       col = "Province", alpha = "Component",
       subtitle = "Conditional auto-regressive (CAR) effect") +
  scale_colour_viridis_d(option = "turbo") +
  theme(axis.text.x = element_blank()) -> p_car

p_car
ggsave(here(figdir,"car.png"), 
       height = 5, width = 8, bg = "white")

```

### Total district deviation

- Province intercept + BYM 

```{r}

fit %>%
  spread_draws(r_adm1_name[adm1_name, Intercept],rcar[guid]) %>% 
  left_join(mutate(prov_guid, guid = as.numeric(guid)), by = "guid") |> 
  filter(adm1_name.x == adm1_name.y) |> 
  median_qi(r_guid = r_adm1_name + rcar) -> tmp

tmp |> 
  left_join(mutate(prov_guid, guid = as.numeric(guid))) |> 
  arrange(adm1_name, guid) |> 
  mutate(did = row_number()) |> 
  ggplot(aes(did, r_guid,
             ymin = .lower, ymax = .upper,
             col = adm1_name)) + 
  geom_hline(yintercept = 0, col = "grey") +
  geom_errorbar() + 
  geom_point() +
  labs(x = "District", y = "Posterior estimate", 
       col = "Province",
       subtitle = "Total district deviation from average") +
  scale_colour_viridis_d(option = "turbo") +
  theme(axis.text.x = element_blank())

ggsave(here(figdir,"district_effects.png"), 
       height = 5, width = 8, bg = "white")

```

## Fitted temporal effects

```{r}

fit |> 
  conditional_smooths() |>
  plot(plot = F) -> tmp

```

### Long-term
#### Overall
```{r}

p_lt_ <- ggplot_build(tmp[[1]])

p_lt_$plot$data |> 
  mutate(effect1__ = (effect1__*47)+1) |> 
  ggplot(mapping = p_lt_$plot$mapping) + 
  geom_ribbon(alpha = 0.4, fill = "grey60") +
  geom_line(col = "#3366FF") +
  scale_x_continuous(breaks = seq(1,48,by=12), labels=2021:2024) +
  labs(y = "Long-term trend", x = NULL) -> p_lt

p_lt
ggsave(here(figdir,"time_longterm.png"), 
       height = 5, width = 7, bg = "white")

```

#### By district
```{r}

p_lt_d_ <- ggplot_build(tmp[[2]])

p_lt_d_$plot$data |> 
  mutate(effect1__ = (effect1__*47)+1) |>  
  rename(District = guid) |> 
  ggplot(mapping = p_lt_d_$plot$mapping) + 
  geom_ribbon(aes(group = District), alpha = 0.01, fill = "grey60", col = NA) +
  geom_line(aes(group = District), alpha = 0.2, col = "#3366FF") +
  guides(col = "none",fill = "none") +
  scale_x_continuous(breaks = seq(1,48,by=12), labels=2021:2024) +
  labs(x = NULL, y = "District-specific deviation") -> p_lt_comb

p_lt_comb
ggsave(here(figdir,"time_longterm_district.png"), 
       height = 5, width = 7, bg = "white")

```

### Season
```{r}

p_season <- ggplot_build(tmp[[3]])

p_season$plot$data |> 
  mutate(effect1__ = (effect1__*11)+1) |>  
  ggplot(mapping = p_season$plot$mapping) + 
  geom_ribbon(alpha = 0.4, fill = "grey60") +
  geom_line(col = "#3366FF") +
  labs(y = "Overall seasonal trend", x = NULL) +
  scale_x_discrete(limits = month.abb) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) -> p_season

p_season
ggsave(here(figdir,"time_season.png"), 
       height = 5, width = 7, bg = "white")

```

```{r}

fit %>%
  gather_draws(r_t[t,]) %>%
  median_qi() |> 
  mutate(t = (t*47)+1) -> summ_r_t

summ_r_t |>  
  ggplot(aes(t, .value,
             ymin = .lower, ymax = .upper)) + 
  geom_hline(yintercept = 0, col = "grey") +
  geom_errorbar() + 
  geom_point() +
  scale_x_continuous(breaks = seq(1,48,by=12), labels=2021:2024) +
  labs(x = "Month", y = "Posterior estimate", subtitle = "Temporal random effect") -> p_iid

p_iid
ggsave(here(figdir,"time_iid.png"), 
       height = 5, width = 7, bg = "white")
```

### Residual 

```{r}

p_season + (p_lt / p_lt_comb) + plot_annotation(tag_levels = "A")

ggsave(here(figdir,"temp_re.png"), 
       height = 5, width = 10, bg = "white")
```

## Extract predictions

Draw predictions for each district/month, including those months with zero observed NPAFP (excluded from fitting)

Note: Currently exclude two entire districts missing from fitting data (no recorded NP-AFP in this period)
```{r}

# Split out 2 districts missing from fitting data
sub1 <- filter(preddata, !guid %in% unique(fitdata$guid))
sub2 <- filter(preddata, guid %in% unique(fitdata$guid)) |> 
  # For now, match guid levels to fitdata and don't try to predict for zero districts
  mutate(guid = factor(guid, levels = unique(fitdata$guid)))

# Expected counts (relative to NPAFP)
## For districts absent from fitting data, predict from model without guid splines
# y1 <- posterior_epred(fit, 
#                       newdata = sub1,
#                       # Exclude s(t, by = guid)
#                       re_formula = ~ (1 | adm1_name) + (1 | t) + s(t, bs = "tp", k = 10) + car(W, gr = guid, type = "bym2") + s(month_of_year, bs = "cc", k = 12),
#                       allow_new_levels = TRUE, sample_new_levels = "uncertainty")

## Predict from all components for remaining districts
y2 <- posterior_epred(fit, 
                      newdata = sub2,
                      # All components
                      re_formula = NULL)

## Combine

# Predicted prevalence
# prev1 <- posterior_linpred(fit, newdata = sub1, transform = T,
#                            re_formula = ~ (1 | adm1_name) + (1 | t) +
#                              car(W, gr = guid, type = "bym2") + 
#                              s(month_of_year, bs = "cc", k = 12),
#                            allow_new_levels = T, sample_new_levels = "gaussian")
prev2 <- posterior_linpred(fit, newdata = sub2, transform = T)

# y <- epred_draws(fit,
#                  newdata = preddata,
                     # newdata = filter(preddata, !grepl("0061E338-05BA", guid)) |> mutate(guid = as.character(guid)),
                     # allow_new_levels = TRUE, sample_new_levels = "gaussian")

# Summarise predictions
y <- y2
y_summ <- as.data.frame(t(apply(y, 2, function(x) {
  c(mean(x), sd(x), quantile(x, 0.025), quantile(x, 0.975)[1])
}))) |> setNames(c("pred_y", "sd_y","low_y", "hi_y"))

pred <- cbind(sub2, y_summ)

prev <- prev2
prev_summ <- as.data.frame(t(apply(prev, 2, function(x) {
  c(mean(x), sd(x), quantile(x, 0.025), quantile(x, 0.975))
}))) |> setNames(c("pred_p", "sd_p", "low_p", "hi_p"))

pred <- cbind(pred, prev_summ)

```

### Overall correlation

Observed vs predicted prevalence of NPEV among NPAFP, per district and month.
```{r}

pred |> 
  arrange(n_npafp) |> 
  ggplot(aes(n_npev, col = n_npafp, size = n_npafp,
                 y = pred_y, ymin = low_y, ymax = hi_y)) + 
  geom_abline() +
  geom_jitter(alpha = 0.7) +  
  guides(size = "none") +
  scale_colour_viridis_b() + 
  labs(x = "Observed NPEV positives (per district/month)",
       y = "Posterior prediction",
       col = "No. tested") + 
  theme(legend.position = c(0.85,0.2), legend.background = element_rect(fill = "white"))
ggsave(here(figdir,"pred_y_scatter.png"),
       height = 6, width = 10, bg = "white")

pred |> 
  arrange(n_npafp) |> 
  ggplot(aes(npev_npafp_p, col = n_npafp, size = n_npafp,
             y = pred_p, ymin = low_p, ymax = hi_p)) + 
  geom_abline() +
  geom_jitter(alpha = 0.7) + 
  guides(size = "none") +
  scale_colour_viridis_b() + 
  labs(x = "Observed NPEV prevalence (per district/month)",
       y = "Posterior prediction",
       col = "No. tested") + 
  theme(legend.position = c(0.85,0.2), legend.background = element_rect(fill = "white"))
ggsave(here(figdir,"pred_prev_scatter.png"),
       height = 6, width = 10, bg = "white")

pred |> 
  filter(n_npafp >=10) |> 
  arrange(n_npafp) |> 
  ggplot(aes(npev_npafp_p, col = n_npafp, size = n_npafp,
             y = pred_p, ymin = low_p, ymax = hi_p)) + 
  geom_abline() +
  geom_jitter(alpha = 0.7) + 
  guides(size = "none") +
  scale_colour_viridis_b() + 
  labs(x = "Observed NPEV prevalence (per district/month)",
       y = "Posterior prediction",
       col = "No. tested",
       caption = "Data subset to district:months with at least 10 NP-AFP notifications") + 
  theme(legend.position = c(0.85,0.2), legend.background = element_rect(fill = "white"))
ggsave(here(figdir,"pred_prev_scatter_gt10.png"),
       height = 6, width = 10, bg = "white")

```
Many month:district with a single NPAFP notification. 
- These still add some information due to pooling

## Plot predictions

### Over time

```{r}

pred |> 
  ggplot(aes(month, group = guid)) + 
  geom_jitter(aes(y = npev_npafp_p), 
             col = "grey", alpha = 0.5, cex = 0.2) +
  geom_ribbon(aes(ymin = low_p, ymax = hi_p), 
              alpha = 0.2, fill = "lightsteelblue") + 
  geom_line(aes(y = pred_p), alpha = 0.2, col = "steelblue4") + 
  # geom_line(aes(y = pred_mean), col = "red", alpha = 0.1) +
  labs(y = "Estimated prevalence", x = "Month", title= "Predicted mean & 95% quantile interval")

pred |> 
  ggplot(aes(month, group = guid)) + 
  geom_jitter(aes(y = npev_npafp_p), 
             col = "grey", alpha = 0.5, cex = 0.2) +
  geom_ribbon(aes(ymin = pred_p - 1.96*sd_p, ymax = pred_p + 1.96*sd_p), 
              alpha = 0.2, fill = "lightsteelblue") + 
  geom_line(aes(y = pred_p), alpha = 0.2, col = "steelblue4") + 
  # geom_line(aes(y = pred_mean), col = "red", alpha = 0.1) +
  labs(y = "Estimated prevalence", x = "Month", title= "Predicted mean & 95% gaussian interval")

```

#### By district

Plot each district trajectory individually against observed prevalence:
```{r}

pred |> 
  ggplot(aes(month, pred_p, col = guid, fill = guid)) +
  geom_ribbon(aes(ymin = low_p, ymax = hi_p), alpha = 0.2, col = NA) +
  geom_line(lwd = 0.2) + 
  geom_line(aes(y = npev_npafp_p), lty = "dashed") +
  scale_colour_viridis_d(option = "turbo") +
  scale_fill_viridis_d(option = "turbo") +
  facet_wrap(~guid) +
  guides(col = "none", fill = "none") +
  labs(x = NULL, y = "Estimated prevalence") -> p_pred_guid

p_pred_guid
pdf(here(figdir,"pred_prev_guid.pdf"), 
       height = 20, width = 30)
p_pred_guid
dev.off()

```

#### Total 
For higher scales, draw samples and aggregate across these:

```{r}

pred_draws <- pred |> 
  add_linpred_draws(fit, transform = T) 

summdata <- pred |> 
  group_by(month) |> 
  summarise(p_obs = sum(n_npev)/sum(n_npafp)) |> ungroup()

pred_draws |> 
  group_by(month) |>
  summarise(pred = mean(.linpred),
            lo = quantile(.linpred, 0.025),
            hi = quantile(.linpred, 0.975)) |> 
  ungroup() |> 
  ggplot(aes(month, pred)) +
  geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.4, fill = "grey60") + 
  geom_line(col = "grey60") + 
  # stat_lineribbon(aes(y = .linpred), .width = c(.95, .80, .50), alpha = 0.2, col = NA) +
  # geom_point(data = summdata, aes(y = p_obs)) +
  geom_line(data = summdata, aes(y = p_obs), lty = "dashed") +
  scale_fill_brewer() +
  labs(x = NULL, y = "Estimated prevalence") -> p_pred_total

p_pred_total
ggsave(here(figdir,"pred_mth_tot.png"),
       p_pred_total,
       height = 6, width = 10, bg = "white")

```
#### By province

*Error in colour/fill by prov*

```{r}

summdata_prov <- pred |> 
  group_by(month, adm1_name) |> 
  summarise(p_obs = sum(n_npev)/sum(n_npafp)) |> ungroup()

pred_draws |> 
  group_by(month, adm1_name) |>
  summarise(pred = mean(.linpred),
            lo = quantile(.linpred, 0.025),
            hi = quantile(.linpred, 0.975)) |> 
  ungroup() |> 
  ggplot(aes(month, pred, fill = adm1_name, col = adm1_name)) +
  geom_ribbon(aes(ymin = lo, ymax = hi, col = NA), alpha = 0.4) + 
  geom_line(aes(col = adm1_name)) + 
  # stat_lineribbon(aes(y = .linpred), .width = c(.95, .80, .50), alpha = 0.2, col = NA) +
  geom_line(data = summdata_prov, aes(y = p_obs, col = adm1_name), lty = "dashed") +
  # geom_point(data = summdata_prov, aes(y = p_obs), col = "black") +
  facet_wrap(~adm1_name) +
  scale_colour_viridis_d(option = "turbo", na.translate = F) +
  scale_fill_viridis_d(option = "turbo") +
  guides(fill = "none") + 
  labs(x = NULL, y = "Estimated prevalence", col = "Province") -> p_pred_prov

p_pred_prov
ggsave(here(figdir,"pred_mth_prov.png"),
       p_pred_prov,
       height = 6, width = 10, bg = "white")

```

```{r}

p_pred_total + p_pred_prov + 
  plot_annotation(tag_levels = "A") + 
  plot_layout(widths = c(4,5))

ggsave(here(figdir,"pred_mth_tot_prov.png"),
       height = 6, width = 14, bg = "white")

```

### Over space

Look at spatial trends every other month, across years.
 
```{r}

pred |> 
  filter(period %% 0.125 == 0) |>
  right_join(shape2) |> 
  filter(!is.na(pred_p)) -> tmp

tmp |> 
  ggplot(aes(fill = pred_p, geometry = SHAPE)) + 
    geom_sf(col = NA) +
    facet_wrap(~month) +
    scale_fill_viridis_c(name = "Predicted NPEV+\nPrevalence") + 
      theme_void() -> p_pred_mth

p_pred_mth
ggsave(here(figdir,"pred_dist_mth.png"),
       height = 6, width = 10, bg = "white")

tmp |> 
  ggplot(aes(fill = sd_p, geometry = SHAPE)) + 
    geom_sf(col = NA) +
    facet_wrap(~month) +
    scale_fill_viridis_c(name = "Predicted NPEV+\nPrevalence (SD)") + 
    theme_void() -> p_pred_mth_sd

p_pred_mth_sd
ggsave(here(figdir,"pred_sd_dist_mth.png"),
       height = 6, width = 10, bg = "white")

```
### Annual averages

To interpret accuracy on an aggregated level, should really weight by no. NPAFP 
- Higher weight in the sum to districts/months with more observations.

```{r}

# agg_yr <- pred %>%
#   group_by(year) %>%
#   mutate(weight = n_npafp / sum(n_npafp)) %>%
#   ungroup()
# 
# # Aggregate each posterior draw
# n_draws <- nrow(prev)
# regions <- unique(agg_yr$year)
# 
# regional_prev <- matrix(NA, nrow = n_draws, ncol = length(regions))
# 
# for(i in seq_along(regions)) {
#   idx <- which(aggregation_data$region == regions[i])
#   weights <- aggregation_data$weight[idx]
#   
#   # Weighted average across districts for each draw
#   regional_prev[, i] <- prev_posterior[, idx] %*% weights
# }
# 
# # Get posterior summaries
# regional_mean <- colMeans(regional_prev)
# regional_lower <- apply(regional_prev, 2, quantile, probs = 0.025)
# regional_upper <- apply(regional_prev, 2, quantile, probs = 0.975)

```

```{r}

pred |>
   group_by(guid, year) |>
   summarise(pred_mean = mean(pred_p),
             pred_sd = mean(sd_p)) |>
   ungroup() |>
   right_join(shape2) |> 
   filter(!is.na(pred_mean)) -> tmp

tmp |>
 ggplot(aes(fill = pred_mean, geometry = SHAPE)) +
   geom_sf(col = NA) +
   facet_wrap(~year) +
   scale_fill_viridis_c(name = "Predicted NPEV+\nPrevalence") +
  theme_void() -> p_pred_yr
p_pred_yr

ggsave(here(figdir,"pred_dist_yr.png"),
       height = 6, width = 10, bg = "white")

tmp |>
  ggplot(aes(fill = pred_sd, geometry = SHAPE)) +
   geom_sf(col = NA) +
   facet_wrap(~year) +
    scale_fill_viridis_c(name = "Predicted NPEV+\nPrevalence (SD)") +
    theme_void() -> p_pred_yr_sd
p_pred_yr_sd

```

Save stan code and data with predicted mean/SD per month/district:

```{r}

stan_final <- stancode(fit)
cmdstanr::write_stan_file(stan_final,
                          dir = here("stan"),
                          basename = "district_prev_final.stan")

saveRDS(pred, here("output/pred_prev_npev.rds"))

pred_draws_1000 <- pred |> 
  add_linpred_draws(fit, ndraws = 1000, transform = T) 
saveRDS(pred_draws, here("output/draws_prev_npev_1000.rds"))

```