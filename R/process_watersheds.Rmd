---
title: "Novel-T modelled watersheds"
output: html_notebook
---

## Objective

Import and combine modelled watersheds from Novel-T platform for ES sites in Pakistan. 

## Unzip and read shapefiles
```{r}
pacman::p_load(tidyverse, sf, here, utils, janitor, mapview)

rootdir <- here("data","Pakistan")

# District shapefiles
shape2 <- readRDS(here(rootdir,"shape2.rds")) |> st_transform(4326)

# Site locations
sites <- st_read(here(rootdir,"es_sites_pak.shp"))

# List sub-folders for catchments
dirs <- list.dirs(path = here(rootdir,"Novel-T"), recursive = F)

# Function to unzip sub-folders
unzip_files <- function(dir, name){
  unzip(here(dir,paste0(name,"_catchments.zip")), 
        exdir = here(dir,paste0(name,"_catchments")))
}

# Unzip all sub-folders
tmp <- lapply(c("adjacent","delineated"),
              \(name) lapply(dirs, unzip_files, name)) 

```

Read all delineated catchments shapefiles into a single sf object.
```{r}

read_catchments <- function(dir,type){
  name = paste0(type,"_catchments")
  dsn = here(dir,name)
  print(dsn)
  st_read(dsn = dsn,
          layer = name, quiet = T) %>% 
    mutate(catchment_type = type)
}

catchments <- lapply(c("adjacent","delineated"),
                     \(name) lapply(dirs, read_catchments, name)) |> 
  bind_rows() |> 
  st_make_valid()

st_crs(catchments)

```

## Explore

### Mapview

```{r}

mapview(filter(catchments, !is.na(site))) +
  mapview(sites)

```

### Plot over shapefiles
```{r}

ggplot() + 
  geom_sf(data = shape2, fill = NA, color = "black") +
  geom_sf(data = catchments |> filter(catchment_type == "delineated"), 
          aes(fill = catchment_type), alpha = 0.5) +
  geom_sf(data = catchments |> filter(catchment_type == "adjacent"), 
          aes(fill = catchment_type), alpha = 0.5) +
  scale_fill_manual(values = c("delineated" = "blue", "adjacent" = "red")) +
  theme_minimal() +
  labs(title = "Novel-T modelled watersheds",
       subtitle = "Pakistan")

```

~18k unique catchments - seems like the "adjacent" and "delineated" labels might refer to areas of the catchment contained in the same district or in an adjacent district?

Intersect district shapefiles with catchments:

```{r}

shape_catch <- st_intersection(shape2, catchments)

shape_sub <- filter(shape2, adm1_name == "")
ggplot() + 
  geom_sf(data = filter(), fill = NA, color = "black") +
  geom_sf(data = catchments |> filter(catchment_type == "delineated"), 
          aes(fill = catchment_type), alpha = 0.5) +
  geom_sf(data = catchments |> filter(catchment_type == "adjacent"), 
          aes(fill = catchment_type), alpha = 0.5) +
  scale_fill_manual(values = c("delineated" = "blue", "adjacent" = "red")) +
  theme_minimal() +
  labs(title = "Novel-T modelled watersheds",
       subtitle = "Pakistan")

```

## Save catchments as RDS

```{r}

saveRDS(catchments, here(rootdir,"catchments.rds"))

```